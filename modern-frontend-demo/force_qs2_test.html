<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>强制QS²模式测试</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 300px; }
        button { background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .metric { display: inline-block; margin: 0 20px 10px 0; }
        .metric-value { font-size: 20px; font-weight: bold; color: #007acc; }
        .metric-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 强制QS²模式测试</h1>
        <p>测试算法API是否正确返回QS²数据</p>
        
        <div class="metric">
            <div class="metric-value" id="qs2Status">❓</div>
            <div class="metric-label">QS²状态</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="apiStatus">❓</div>
            <div class="metric-label">API状态</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="dataStatus">❓</div>
            <div class="metric-label">数据状态</div>
        </div>
        
        <button onclick="testQS2Mode()">🧪 测试QS²模式</button>
        <button onclick="clearCache()">🧹 清除缓存</button>
        <button onclick="window.location.href='/'">🏠 返回主页</button>
        
        <div id="results"></div>
    </div>

    <script>
        async function testQS2Mode() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">🔄 正在测试QS²模式...</div>';
            
            try {
                // 测试1: 检查算法API是否返回QS²数据
                console.log('🧪 测试1: 检查算法API返回数据...');
                const algorithmResponse = await fetch('/api/algorithm/execution');
                const algorithmData = await algorithmResponse.json();
                
                document.getElementById('apiStatus').textContent = algorithmResponse.ok ? '✅' : '❌';
                
                if (!algorithmData.success) {
                    throw new Error('算法API返回失败');
                }
                
                // 测试2: 检查QS²演示数据
                console.log('🧪 测试2: 检查QS²演示数据...');
                const demoResponse = await fetch('/api/qs2/demo');
                const demoData = await demoResponse.json();
                
                if (!demoData.success) {
                    throw new Error('QS²演示数据获取失败');
                }
                
                // 测试3: 模拟前端算法API调用
                console.log('🧪 测试3: 模拟前端算法API转换...');
                
                // 模拟algorithmAPI.getLatestExecution()逻辑
                let finalData = null;
                
                // 优先使用QS²演示数据
                if (demoData.success && demoData.data) {
                    console.log('✅ 使用QS²演示数据');
                    finalData = convertQS2ToAlgorithmExecution(demoData);
                    document.getElementById('qs2Status').textContent = '🧠';
                    document.getElementById('dataStatus').textContent = '✅';
                } else {
                    console.log('⚠️ 回退到标准算法数据');
                    finalData = algorithmData.data;
                    document.getElementById('qs2Status').textContent = '⚠️';
                    document.getElementById('dataStatus').textContent = '⚠️';
                }
                
                // 检查最终数据是否包含QS²标识
                const hasQS2Features = finalData.final_result?.is_qs2_enhanced || 
                                      finalData.final_result?.algorithm_type === 'QS2_Enhanced';
                
                // 生成报告
                const report = {
                    algorithmAPI: {
                        success: algorithmResponse.ok,
                        data: algorithmData
                    },
                    qs2Demo: {
                        success: demoResponse.ok,
                        data: demoData
                    },
                    finalData: finalData,
                    hasQS2Features: hasQS2Features,
                    shouldShowQS2: hasQS2Features
                };
                
                resultsDiv.innerHTML = `
                    <div class="status ${hasQS2Features ? 'success' : 'error'}">
                        ${hasQS2Features ? '✅ QS²模式应该已启用!' : '❌ QS²模式未启用'}
                    </div>
                    <div class="status info">
                        <strong>测试结果:</strong><br>
                        算法API: ${algorithmResponse.ok ? '✅' : '❌'}<br>
                        QS²演示数据: ${demoResponse.ok ? '✅' : '❌'}<br>
                        QS²特征检测: ${hasQS2Features ? '✅' : '❌'}<br>
                        预期界面标题: ${hasQS2Features ? '"🧠 QS²语义关系图"' : '"🔬 数学关系情景图"'}
                    </div>
                    <details>
                        <summary>查看完整测试报告</summary>
                        <pre>${JSON.stringify(report, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                document.getElementById('qs2Status').textContent = '❌';
                document.getElementById('apiStatus').textContent = '❌';
                document.getElementById('dataStatus').textContent = '❌';
                
                resultsDiv.innerHTML = `
                    <div class="status error">
                        ❌ 测试失败: ${error.message}
                    </div>
                `;
            }
        }
        
        function convertQS2ToAlgorithmExecution(qs2Data) {
            const currentTime = Date.now() / 1000;
            const qs2Stages = qs2Data.data.algorithm_stages.map((stage, index) => ({
                stage_id: `qs2_stage_${index}`,
                stage_name: stage.name,
                timestamp: currentTime + index,
                duration_ms: stage.duration_ms,
                confidence: stage.confidence,
                algorithm_state: {
                    phase: stage.name,
                    is_qs2_enhanced: true,
                    algorithm_type: 'QS2_Enhanced'
                }
            }));
            
            return {
                execution_id: qs2Data.execution_id || `qs2_${Date.now()}`,
                problem_text: qs2Data.problem_text || '数学问题',
                start_time: currentTime,
                end_time: currentTime + 1,
                total_duration_ms: qs2Data.data.algorithm_stages.reduce((sum, stage) => sum + stage.duration_ms, 0),
                stages: qs2Stages,
                final_result: {
                    entities: qs2Data.data.entities,
                    relations: qs2Data.data.relationships,
                    algorithm_type: 'QS2_Enhanced',
                    is_qs2_enhanced: true
                }
            };
        }
        
        function clearCache() {
            // 清除浏览器缓存
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // 强制刷新页面
            window.location.reload(true);
        }
        
        // 页面加载后自动运行测试
        window.addEventListener('load', () => {
            setTimeout(testQS2Mode, 1000);
        });
    </script>
</body>
</html>