<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶QSÂ²æ¨¡å¼æµ‹è¯•</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 300px; }
        button { background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .metric { display: inline-block; margin: 0 20px 10px 0; }
        .metric-value { font-size: 20px; font-weight: bold; color: #007acc; }
        .metric-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¼ºåˆ¶QSÂ²æ¨¡å¼æµ‹è¯•</h1>
        <p>æµ‹è¯•ç®—æ³•APIæ˜¯å¦æ­£ç¡®è¿”å›QSÂ²æ•°æ®</p>
        
        <div class="metric">
            <div class="metric-value" id="qs2Status">â“</div>
            <div class="metric-label">QSÂ²çŠ¶æ€</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="apiStatus">â“</div>
            <div class="metric-label">APIçŠ¶æ€</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="dataStatus">â“</div>
            <div class="metric-label">æ•°æ®çŠ¶æ€</div>
        </div>
        
        <button onclick="testQS2Mode()">ğŸ§ª æµ‹è¯•QSÂ²æ¨¡å¼</button>
        <button onclick="clearCache()">ğŸ§¹ æ¸…é™¤ç¼“å­˜</button>
        <button onclick="window.location.href='/'">ğŸ  è¿”å›ä¸»é¡µ</button>
        
        <div id="results"></div>
    </div>

    <script>
        async function testQS2Mode() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•QSÂ²æ¨¡å¼...</div>';
            
            try {
                // æµ‹è¯•1: æ£€æŸ¥ç®—æ³•APIæ˜¯å¦è¿”å›QSÂ²æ•°æ®
                console.log('ğŸ§ª æµ‹è¯•1: æ£€æŸ¥ç®—æ³•APIè¿”å›æ•°æ®...');
                const algorithmResponse = await fetch('/api/algorithm/execution');
                const algorithmData = await algorithmResponse.json();
                
                document.getElementById('apiStatus').textContent = algorithmResponse.ok ? 'âœ…' : 'âŒ';
                
                if (!algorithmData.success) {
                    throw new Error('ç®—æ³•APIè¿”å›å¤±è´¥');
                }
                
                // æµ‹è¯•2: æ£€æŸ¥QSÂ²æ¼”ç¤ºæ•°æ®
                console.log('ğŸ§ª æµ‹è¯•2: æ£€æŸ¥QSÂ²æ¼”ç¤ºæ•°æ®...');
                const demoResponse = await fetch('/api/qs2/demo');
                const demoData = await demoResponse.json();
                
                if (!demoData.success) {
                    throw new Error('QSÂ²æ¼”ç¤ºæ•°æ®è·å–å¤±è´¥');
                }
                
                // æµ‹è¯•3: æ¨¡æ‹Ÿå‰ç«¯ç®—æ³•APIè°ƒç”¨
                console.log('ğŸ§ª æµ‹è¯•3: æ¨¡æ‹Ÿå‰ç«¯ç®—æ³•APIè½¬æ¢...');
                
                // æ¨¡æ‹ŸalgorithmAPI.getLatestExecution()é€»è¾‘
                let finalData = null;
                
                // ä¼˜å…ˆä½¿ç”¨QSÂ²æ¼”ç¤ºæ•°æ®
                if (demoData.success && demoData.data) {
                    console.log('âœ… ä½¿ç”¨QSÂ²æ¼”ç¤ºæ•°æ®');
                    finalData = convertQS2ToAlgorithmExecution(demoData);
                    document.getElementById('qs2Status').textContent = 'ğŸ§ ';
                    document.getElementById('dataStatus').textContent = 'âœ…';
                } else {
                    console.log('âš ï¸ å›é€€åˆ°æ ‡å‡†ç®—æ³•æ•°æ®');
                    finalData = algorithmData.data;
                    document.getElementById('qs2Status').textContent = 'âš ï¸';
                    document.getElementById('dataStatus').textContent = 'âš ï¸';
                }
                
                // æ£€æŸ¥æœ€ç»ˆæ•°æ®æ˜¯å¦åŒ…å«QSÂ²æ ‡è¯†
                const hasQS2Features = finalData.final_result?.is_qs2_enhanced || 
                                      finalData.final_result?.algorithm_type === 'QS2_Enhanced';
                
                // ç”ŸæˆæŠ¥å‘Š
                const report = {
                    algorithmAPI: {
                        success: algorithmResponse.ok,
                        data: algorithmData
                    },
                    qs2Demo: {
                        success: demoResponse.ok,
                        data: demoData
                    },
                    finalData: finalData,
                    hasQS2Features: hasQS2Features,
                    shouldShowQS2: hasQS2Features
                };
                
                resultsDiv.innerHTML = `
                    <div class="status ${hasQS2Features ? 'success' : 'error'}">
                        ${hasQS2Features ? 'âœ… QSÂ²æ¨¡å¼åº”è¯¥å·²å¯ç”¨!' : 'âŒ QSÂ²æ¨¡å¼æœªå¯ç”¨'}
                    </div>
                    <div class="status info">
                        <strong>æµ‹è¯•ç»“æœ:</strong><br>
                        ç®—æ³•API: ${algorithmResponse.ok ? 'âœ…' : 'âŒ'}<br>
                        QSÂ²æ¼”ç¤ºæ•°æ®: ${demoResponse.ok ? 'âœ…' : 'âŒ'}<br>
                        QSÂ²ç‰¹å¾æ£€æµ‹: ${hasQS2Features ? 'âœ…' : 'âŒ'}<br>
                        é¢„æœŸç•Œé¢æ ‡é¢˜: ${hasQS2Features ? '"ğŸ§  QSÂ²è¯­ä¹‰å…³ç³»å›¾"' : '"ğŸ”¬ æ•°å­¦å…³ç³»æƒ…æ™¯å›¾"'}
                    </div>
                    <details>
                        <summary>æŸ¥çœ‹å®Œæ•´æµ‹è¯•æŠ¥å‘Š</summary>
                        <pre>${JSON.stringify(report, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                document.getElementById('qs2Status').textContent = 'âŒ';
                document.getElementById('apiStatus').textContent = 'âŒ';
                document.getElementById('dataStatus').textContent = 'âŒ';
                
                resultsDiv.innerHTML = `
                    <div class="status error">
                        âŒ æµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }
        
        function convertQS2ToAlgorithmExecution(qs2Data) {
            const currentTime = Date.now() / 1000;
            const qs2Stages = qs2Data.data.algorithm_stages.map((stage, index) => ({
                stage_id: `qs2_stage_${index}`,
                stage_name: stage.name,
                timestamp: currentTime + index,
                duration_ms: stage.duration_ms,
                confidence: stage.confidence,
                algorithm_state: {
                    phase: stage.name,
                    is_qs2_enhanced: true,
                    algorithm_type: 'QS2_Enhanced'
                }
            }));
            
            return {
                execution_id: qs2Data.execution_id || `qs2_${Date.now()}`,
                problem_text: qs2Data.problem_text || 'æ•°å­¦é—®é¢˜',
                start_time: currentTime,
                end_time: currentTime + 1,
                total_duration_ms: qs2Data.data.algorithm_stages.reduce((sum, stage) => sum + stage.duration_ms, 0),
                stages: qs2Stages,
                final_result: {
                    entities: qs2Data.data.entities,
                    relations: qs2Data.data.relationships,
                    algorithm_type: 'QS2_Enhanced',
                    is_qs2_enhanced: true
                }
            };
        }
        
        function clearCache() {
            // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // å¼ºåˆ¶åˆ·æ–°é¡µé¢
            window.location.reload(true);
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(testQS2Mode, 1000);
        });
    </script>
</body>
</html>